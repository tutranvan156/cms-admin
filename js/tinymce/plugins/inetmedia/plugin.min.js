/**
 * iNet media lib
 * insert image from: media lib, upload to media lib and use, image link
 * created by Huyen Doan <huyendv@inetcloud.vn>
 */

tinymce.PluginManager.add('inetmedia', function (editor) {
  var olMenuItems, lastStyles = {};
  var tinymceMedia = {title: 'brief', mediaId: 'uuid', name: 'file', service: 'service'};

  function buildMenuItems(data) {
    var items = [];
    var __data = data || [];
    for (var i = 0; i < __data.length; i++) {
      items.push({
        text: __data[i].name,
        data: __data[i].code
      });
    }

    return items;
  }

  console.log('edit...');

  editor.addButton('customlink', {
    text: 'Liên kết trang',
    icon: false,
    onclick: function () {
      console.log('click...');
      tinymce.fire('custom_link');
    }
  });

  var __imediaData = editor.settings.imediaData || [];
  if (__imediaData.length <= 0) {
    __imediaData = [{
      code: 'LIB_IMAGE',
      name: 'Chọn hình ảnh'
    }, {
      code: 'UPLOAD_IMAGE',
      name: 'Tải lên hình ảnh'
    }, {
      code: 'LINK_IMAGE',
      name: 'Nhập đường dẫn hình ảnh'
    }]
  }
  olMenuItems = buildMenuItems(__imediaData);

  function selectedChange(e) {
    if (e == 'UPLOAD_IMAGE') {
      openUpload();
    } else if (e == 'LINK_IMAGE') {
      openLink();
    } else if (e == 'LIB_IMAGE') {
      openMediaLib();
    }
  }

  function openMediaLib() {
    tinymce.fire('mediaimageselector');
  }

  function openUpload() {
    tinymce.fire('mediaimageupload');
  }

  function openLink() {
    tinymce.fire('mediaimagelink');
  }

  editor.addButton('image', {
    type: 'splitbutton',
    tooltip: 'Chọn hình ảnh',
    menu: olMenuItems,
    onselect: function (e) {
      selectedChange(e.control.settings.data);
    },
    onclick: function () {
      selectedChange('LIB_IMAGE');
    }
  });

  tinymce.inetmediaAddImage = function (src, data) {
    var __src = src || '';
    if (__src != '') {
      var __div = {
        'data-service': 'community-asset-upload'
      };
      var __img = {
        id: '__mcenew',
        src: __src,
        alt: data[tinymceMedia.title] || '',
        title: data[tinymceMedia.title] || '',
        width: null,
        height: null,
        style: '',
        "class": ''
      };
      var imgElm = editor.selection.getNode();
      editor.focus();
      editor.selection.setContent(editor.dom.createHTML('div', __div, editor.dom.createHTML('img', __img)));
      imgElm = editor.dom.get('__mcenew');
      editor.dom.setAttribs(imgElm, {
        'id': null,
        'data-item': data[tinymceMedia.mediaId],
        'data-name': data[tinymceMedia.name],
        'data-image': true
      });
    }
  };
});